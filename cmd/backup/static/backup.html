
{{define "content"}}
    <style>
        .pagination .page-link {
            border-width: 1px;
        }
    </style>
    <div class="row">
        <div class="col">
            <div  class="panel ">
                <div class="panel-container show">
                    <div class="panel-content">
                        <div id="toolbar-backup">
                        </div>
                        <table  id="table-backup"
                                class="table-sm"
                                data-toggle="table"
                                data-toolbar="#toolbar-backup"
                                data-search="true"
                                data-url="/summaries"
                                data-pagination="true"
                                data-show-export="true"
                                data-export-types="['csv', 'txt', 'excel']"
                                data-side-pagination="client"
                                data-show-refresh="true"
                                data-show-columns="true"
                                data-sort-name="id"
                                data-show-toggle="true"
                                data-page-size="20"
                                data-sort-order="desc">
                            <thead>
                            <tr>
                                <th data-field="id" data-sortable="true">ID</th>
                                <th data-field="date" data-sortable="true" data-formatter="dateFormatter">Date</th>
                                <th data-field="srcDir" data-sortable="true">Backup Dir.</th>
                                <th data-field="backupType" data-sortable="true" data-formatter="backupTypeFormatter">Type</th>
                                <th data-field="state" data-sortable="true" data-formatter="backupStateFormatter">Result</th>
                                <th data-field="execTime" data-sortable="true" data-formatter="toFixedFormatter">Time(Sec)</th>

                                <th data-field="workerCount" data-sortable="true" data-visible="false">Workers</th>

                                <th data-field="totalCount" data-sortable="true" data-formatter="thCommaFormatter">Files</th>
                                <th data-field="totalSize" data-sortable="true" data-formatter="bytesTooltipFormatter">Total Size (B)</th>

                                <th data-field="countAdded" data-sortable="true" data-formatter="backupResultFormatter" data-events="backupOperateEvents">Added</th>
                                <th data-field="sizeAdded" data-sortable="true" data-formatter="bytesTooltipFormatter" data-visible="true">Added (B)</th>

                                <th data-field="countModified" data-sortable="true" data-formatter="backupResultFormatter" data-events="backupOperateEvents">Modified </th>
                                <th data-field="sizeModified" data-sortable="true" data-formatter="bytesTooltipFormatter" data-visible="true">Modified (B)</th>

                                <th data-field="countDeleted" data-sortable="true" data-formatter="backupResultFormatter" data-events="backupOperateEvents">Deleted </th>
                                <th data-field="sizeDeleted" data-sortable="true" data-formatter="bytesTooltipFormatter" data-visible="true">Deleted (B)</th>

                                <th data-field="countFailed" data-sortable="true" data-formatter="backupResultFormatter" data-events="backupOperateEvents">Failed </th>
                                <th data-field="sizeFailed" data-sortable="true" data-formatter="bytesTooltipFormatter" data-visible="true">Failed (B)</th>

                                <th data-field="countSuccess" data-sortable="true" data-formatter="backupResultFormatter" data-events="backupOperateEvents">Success</th>
                                <th data-field="sizeSuccess" data-sortable="true" data-formatter="bytesTooltipFormatter" data-visible="true">Success (B) </th>

                                <th data-field="extensions" data-sortable="true" data-formatter="backupExtFormatter">Extension</th>
                                <th data-field="sizeDistribution" data-sortable="true">sizeDistribution</th>
                                <th data-field="message" data-sortable="true">message </th>
                                <th data-field="readingTime" data-sortable="true" data-formatter="dateFormatter" data-visible="false">1) Reading </th>
                                <th data-field="comparisonTime" data-sortable="true" data-formatter="dateFormatter" data-visible="false">2) Compare</th>
                                <th data-field="backupTime" data-sortable="true" data-formatter="dateFormatter" data-visible="false">3) Backup</th>
                                <th data-field="loggingTime" data-sortable="true" data-formatter="dateFormatter" data-visible="false">4) Logging </th>
                            </tr>
                            </thead>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>


    <div class="modal fade" id="modal-backup-changes" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Modal title</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true"><i class="fal fa-times"></i></span>
                    </button>
                </div>
                <div class="modal-body">
                    <table  id="table-backup-added"
                            class="table-data table-sm"
                            data-toggle="table"
                            data-search="true"
                            data-pagination="true"
                            data-show-export="true"
                            data-pagination-v-align="both"
                            data-export-types="['csv', 'txt', 'excel']"
                            data-side-pagination="client"
                            data-sort-name="name"
                            data-page-size="20"
                            data-sort-order="asc">
                        <thead>
                        <tr>
                            <th data-field="path" data-sortable="true" data-formatter="backupPathFormatter">Name</th>
                            <th data-field="mtime" data-visible="false">Modified</th>
                            <th data-field="size" data-sortable="true">Size</th>
                            <th data-field="result" data-sortable="true">Result</th>
                        </tr>
                        </thead>
                    </table>
                    <table  id="table-backup-modified"
                            class="table-data table-sm"
                            data-toggle="table"
                            data-search="true"
                            data-pagination="true"
                            data-show-export="true"
                            data-export-types="['csv', 'txt', 'excel']"
                            data-side-pagination="client"
                            data-sort-name="name"
                            data-page-size="20"
                            data-sort-order="asc">
                        <thead>
                        <tr>
                            <th data-field="name" data-sortable="true">Name</th>
                            <th data-field="size" data-sortable="true">Size</th>
                            <th data-field="result" data-sortable="true">Result</th>
                        </tr>
                        </thead>
                    </table>
                    <table  id="table-backup-deleted"
                            class="table-data table-sm"
                            data-toggle="table"
                            data-search="true"
                            data-pagination="true"
                            data-show-export="true"
                            data-export-types="['csv', 'txt', 'excel']"
                            data-side-pagination="client"
                            data-sort-name="name"
                            data-page-size="20"
                            data-sort-order="asc">
                        <thead>
                        <tr>
                            <th data-field="name" data-sortable="true">Name</th>
                            <th data-field="size" data-sortable="true">Size</th>
                            <th data-field="result" data-sortable="true">Result</th>
                        </tr>
                        </thead>
                    </table>
                    <table  id="table-backup-failed"
                            class="table-data table-sm"
                            data-toggle="table"
                            data-search="true"
                            data-pagination="true"
                            data-show-export="true"
                            data-export-types="['csv', 'txt', 'excel']"
                            data-side-pagination="client"
                            data-sort-name="name"
                            data-page-size="20"
                            data-sort-order="asc">
                        <thead>
                        <tr>
                            <th data-field="name" data-sortable="true">Name</th>
                            <th data-field="size" data-sortable="true">Size</th>
                            <th data-field="result" data-sortable="true">Result</th>
                        </tr>
                        </thead>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary">Save changes</button>
                </div>
            </div>
        </div>
    </div>
{{end}}

{{define "script"}}
    <script>

        $('#modal-backup-changes')
            .on('show.bs.modal', function (e) {
            }).on('hidden.bs.modal', function (e) {
                console.log("333");
                $(".table-data").bootstrapTable("removeAll");
            });



        $("#table-backup").on('load-success.bs.table', function (e, data) {
            $('.has-popover').popover();
        });

        window.backupOperateEvents = {
            'click .file': function (e, val, row, idx) {
                console.log(row);
                let $btn = $(e.currentTarget);
                // $("#modal-files .modal-title").text($btn.data("title"));

                // console.log($btn.data("field"));
                showChangedFiles(row.id, $btn.data("title"), $btn.data("field"));
                // getBackupFiles(row, $btn.data("field"));
                // $("#modal-files").modal("show");
            },
        };

        function bytesFormatter(val, row, idx) {
            return bytesToSize(val);
        }
        // function dateOnlyFormatter(val, row, idx) {
        //     return moment(val).format("ll");
        // }
        function dateFormatter(val, row, idx) {
            return moment(val).format("YYYY-MM-DD HH:mm:ss");
        }
        function bytesToSize(bytes) {
            return toHumanizedSize(bytes, true);
            // let sizes = ['B', 'kB', 'MB', 'GB', 'TB'];
            // if (bytes == 0) return '0 Byte';
            // let i = parseInt(Math.floor(Math.log(bytes) / Math.log(1024)));
            // return Math.round(bytes / Math.pow(1024, i), 2) + ' ' + sizes[i];
        }

        function toHumanizedSize(bytes, si) {
            let thresh = si ? 1000 : 1024;
            if(Math.abs(bytes) < thresh) {
                return bytes + ' B';
            }
            let units = si
                ? ['kB','MB','GB','TB','PB','EB','ZB','YB']
                : ['KiB','MiB','GiB','TiB','PiB','EiB','ZiB','YiB'];
            let u = -1;
            do {
                bytes /= thresh;
                ++u;
            } while(Math.abs(bytes) >= thresh && u < units.length - 1);
            return bytes.toFixed(1)+' '+units[u];
        }

        function bytesWithSize(bytes, prefix, suffix) {
            if (prefix === undefined) {
                prefix = "";
            }
            if (suffix === undefined) {
                suffix = "";
            }
            console.log("==================");
            console.log(bytes + " B");
            console.log(bytesToSize(bytes));
            // console.log((bytes + " B") === bytesToSize(bytes));
            if ((bytes + " B") == bytesToSize(bytes)) {
                return bytesToSize(bytes);
            }
            return bytesToSize(bytes) + prefix + bytes.toLocaleString() + " B" + suffix;
        }

        function basename(str)
        {
            var base = new String(str).substring(str.lastIndexOf('/') + 1);
            if(base.lastIndexOf(".") != -1)
                base = base.substring(0, base.lastIndexOf("."));
            return base;
        }

        function dirname(path) {
            return path.match(/.*\//);
        }

        function showChangedFiles(id, title, field) {
            let url = "/summaries/" + id + "/changes";
            $.ajax({
                url: url,
            }).done(function(report) {
                console.log(report);
                $("#table-backup-added").bootstrapTable("load", report.added.files);
                $("#table-backup-modified").bootstrapTable("load", report.modified.files);
                $("#table-backup-deleted").bootstrapTable("load", report.deleted.files);
                $("#table-backup-failed").bootstrapTable("load", report.failed.files);

                $("#modal-backup-changes .modal-title").text(title);
                $("#modal-backup-changes").modal("show");
            });
        }


        /*
        * Formatters
        */
        function backupPathFormatter(val, row, idx) {
            return val;
        }

        function backupResultFormatter(val, row, idx, field) {
            let th = $('#table-backup').find("[data-field='" + field + "']");

            if (val === 0) {
                return '<span class="text-muted">' + val + '</span>';
            }
            let link = $("<a/>", {
                href: "#",
                class: "file",
                "data-title": th.text(),
                "data-field": field,
                // class: "has-popover",
                // "data-toggle": "popover",
                // "data-trigger":"hover",
                // "data-placement": "top",
                "title": "",
                // "data-original-title": row.countAdded + ' file(s) added',
                // "data-html": true,
                // "data-content": bytesWithSize(row.sizeAdded, "<br>"),
            }).html(
                val.toLocaleString()
            );
            return link[0].outerHTML;

            // return [
            //     '<a class="file" href="javascript:void(0)" title="Like">',
            //     '<i class="fa fa-heart"></i>',
            //     '</a>  ',
            // ].join('')

        }

        function backupTypeFormatter(val, row, idx) {
            if (val === 1) {
                return 'Initial';
            }
            if (val === 2) {
                return 'Incremental';
            }
        }

        function backupExtFormatter(val, row, idx) {
            return '<a href="#" class="extension">Ext</a>';
        }

        function backupStateFormatter(val, row, idx) {
            if (val === 5) {
                return 'Completed';
            }
            return val;
        }

        function backupSrcDirsFormatter(val, row, idx) {
            return val.join("<br>");
        }



        function backupResultSizeFormatter(val, row, idx, field) {
            if (val === 0) {
                return '<span class="text-muted">' + val + '</span>';
            }

            let size = -1;
            if (field.endsWith("Added")) {
                size = row.countAdded;
            }


            console.log(  );

            let link = $("<a/>", {
                href: "#",
                class: "has-popover",
                "data-toggle": "popover",
                "data-trigger":"hover",
                "data-placement": "top",
                "title": "",
                "data-original-title": val+ ' file(s) ' + field.substr(4).toLowerCase(),
                "data-html": true,
                "data-content": bytesWithSize(val, "<br>"),
            }).html(
                val.toLocaleString()
            );
            return link[0].outerHTML;
        }

        // function backupAddedFormatter(val, row, idx) {
        //     let link = $("<a/>", {
        //         href: "#",
        //         class: "has-popover",
        //         "data-toggle": "popover",
        //         "data-trigger":"hover",
        //         "data-placement": "top",
        //         "title": "",
        //         "data-original-title": row.countAdded + ' file(s) added',
        //         "data-html": true,
        //         "data-content": bytesWithSize(row.sizeAdded, "<br>"),
        //     }).html(
        //         val.toLocaleString()
        //     );
        //     return link[0].outerHTML;
        // }
        // function backupModifiedFormatter(val, row, idx) {
        //     let link = $("<a/>", {
        //         href: "#",
        //         class: "has-popover",
        //         "data-toggle": "popover",
        //         "data-trigger":"hover",
        //         "data-placement": "top",
        //         "title": "",
        //         "data-original-title": row.countModified + ' file(s) modified',
        //         "data-html": true,
        //         "data-content": bytesWithSize(row.sizeModified, "<br>"),
        //     }).html(
        //         val.toLocaleString()
        //     );
        //     return link[0].outerHTML;
        // }
        // function backupDeletedFormatter(val, row, idx) {
        //     let link = $("<a/>", {
        //         href: "#",
        //         class: "has-popover",
        //         "data-toggle": "popover",
        //         "data-trigger":"hover",
        //         "data-placement": "top",
        //         "title": "",
        //         "data-original-title": row.countDeleted + ' file(s) deleted',
        //         "data-html": true,
        //         "data-content": bytesWithSize(row.sizeDeleted, "<br>"),
        //     }).html(
        //         val.toLocaleString()
        //     );
        //     return link[0].outerHTML;
        // }
        //
        // function backupFailedFormatter(val, row, idx) {
        //     let link = $("<a/>", {
        //         href: "#",
        //         class: "has-popover",
        //         "data-toggle": "popover",
        //         "data-trigger":"hover",
        //         "data-placement": "top",
        //         "title": "",
        //         "data-original-title": row.countFailed + ' file(s) failed to backup',
        //         "data-html": true,
        //         "data-content": bytesWithSize(row.sizeFailed, "<br>"),
        //     }).html(
        //         val.toLocaleString()
        //     );
        //     return link[0].outerHTML;
        // }
        //
        // function backupSuccessFormatter(val, row, idx) {
        //     let link = $("<a/>", {
        //         href: "#",
        //         class: "has-popover",
        //         "data-toggle": "popover",
        //         "data-trigger":"hover",
        //         "data-placement": "top",
        //         "title": "",
        //         "data-original-title": row.countSuccess + ' file(s) failed to backup',
        //         "data-html": true,
        //         "data-content": bytesWithSize(row.sizeSuccess, "<br>"),
        //     }).html(
        //         val.toLocaleString()
        //     );
        //     return link[0].outerHTML;
        // }

        // function backupAddedCountFormatter(val, row, idx) {
        //     let link = $("<a/>", {
        //         href: "#",
        //         class: "has-popover",
        //         "data-toggle": "popover",
        //         "data-trigger":"hover",
        //         "data-placement": "top",
        //         "title": "",
        //         "data-original-title": val.toLocaleString() + ' file(s) added',
        //         "data-html": true,
        //         "data-content": row.sizeAdded.toLocaleString() + " B" + "<br>" + bytesToSize(row.sizeAdded),
        //     }).html(
        //         val.toLocaleString()
        //         + '<br><span class="text-info">' + bytesToSize(row.sizeAdded) + "</span>"
        //     );
        //     return link[0].outerHTML;
        // }
        // function backupModifiedCountFormatter(val, row, idx) {
        //     let link = $("<a/>", {
        //         href: "#",
        //         class: "has-popover",
        //         "data-toggle": "popover",
        //         "data-trigger":"hover",
        //         "data-placement": "top",
        //         "title": "",
        //         "data-original-title": val.toLocaleString() + ' file(s) modified',
        //         "data-html": true,
        //         "data-content": row.sizeModified.toLocaleString() + " B" + "<br>" + bytesToSize(row.sizeModified),
        //     }).html(
        //         val.toLocaleString()
        //         + '<br><span class="text-success">' + bytesToSize(row.sizeModified) + "</span>"
        //     );
        //     return link[0].outerHTML;
        // }
        // function backupDeletedCountFormatter(val, row, idx) {
        //     let link = $("<a/>", {
        //         href: "#",
        //         class: "has-popover",
        //         "data-toggle": "popover",
        //         "data-trigger":"hover",
        //         "data-placement": "top",
        //         "title": "",
        //         "data-original-title": val.toLocaleString() + ' file(s) deleted',
        //         "data-html": true,
        //         "data-content": row.sizeDeleted.toLocaleString() + " B" + "<br>" + bytesToSize(row.sizeDeleted),
        //     }).html(
        //         val.toLocaleString()
        //         + '<br><span class="text-danger">' + bytesToSize(row.sizeDeleted) + "</span>"
        //     );
        //     return link[0].outerHTML;
        // }

        function toFixedFormatter(val, row, idx) {
            return  val.toFixed(2);
        }
        function backupFailedCountFormatter(val, row, idx) {
            let str =  val.toLocaleString();
            if (val > 0) {
                str = '<span class="text-danger"><i class="fa fa-exclamation-triangle"></i> ' + str + '<br>' + bytesToSize(row.failedSize) + "</span>";
            }
            return str;
        }

        function thCommaFormatter(val, row, idx) {
            return val.toLocaleString();
        }

        function bytesTooltipFormatter(val, row, idx) {
            let link = $("<a/>", {
                href: "#",
                class: "has-popover",
                "data-toggle": "popover",
                "data-trigger":"hover",
                "data-placement": "top",
                "title": "",
                "data-original-title": bytesToSize(val),
                "data-html": true,
            }).html(
                val.toLocaleString()
            );
            return link[0].outerHTML;

        }

        // function basename(str, sep) {
        //     return str.substr(str.lastIndexOf(sep) + 1);
        // }
        //
        // function strip_extension(str) {
        //     return str.substr(0,str.lastIndexOf('.'));
        // }

    </script>
{{end}}